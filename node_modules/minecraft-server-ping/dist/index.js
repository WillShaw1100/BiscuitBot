"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ping = exports.pingUri = void 0;
const dns_1 = require("dns");
const net_1 = require("net");
const varint_1 = require("varint");
const PacketDecoder_1 = require("./PacketDecoder");
const PROTOCOL_VERSION = 736; // Minecraft 1.16.1
/**
 * ping with URI
 * @param {string} uri minecraft://server[:port]
 * @return {Promise<IMinecraftData>}
 */
function pingUri(uri, options = {}) {
    const { protocol, hostname, port } = new URL(uri);
    if (!hostname || !protocol || protocol !== 'minecraft:') {
        throw new TypeError('not correct minecraft URI');
    }
    return ping(hostname, port ? parseInt(port, 10) : undefined, options);
}
exports.pingUri = pingUri;
/**
 * ping with hostname and port
 * @param {string=} hostname hostname
 * @param {number=} port port number (defaults 25565)
 * @returns {Promise<IMinecraftData>}
 */
async function ping(hostname = 'localhost', port = 25565, options = {}) {
    let address = { hostname, port };
    try {
        address = await checkSrvRecord(address.hostname);
    }
    catch (err) {
        // ignore
    }
    return openConnection(address, options);
}
exports.ping = ping;
function checkSrvRecord(hostname) {
    return new Promise((resolve, reject) => {
        if ((0, net_1.isIP)(hostname) !== 0) {
            reject(new Error('Hostname is an IP address'));
        }
        else {
            (0, dns_1.resolveSrv)('_minecraft._tcp.' + hostname, (error, result) => {
                if (error) {
                    reject(error);
                }
                else {
                    if (result.length === 0 || !result[0]) {
                        reject(new Error('dns: no srv found with name'));
                    }
                    else {
                        resolve({
                            hostname: result[0].name,
                            port: result[0].port,
                        });
                    }
                }
            });
        }
    });
}
function openConnection(address, options) {
    let timeout;
    return new Promise((resolve, reject) => {
        const socket = (0, net_1.createConnection)(address.port, address.hostname, async () => {
            const packetDecoder = new PacketDecoder_1.PacketDecoder();
            socket.pipe(packetDecoder);
            packetDecoder.once('error', (error) => {
                socket.destroy();
                if (timeout) {
                    clearTimeout(timeout);
                }
                reject(error);
            });
            // handshake
            socket.write(createHandshakePacket(address));
            const handshakeData = await packetDecoder.oncePromise('handshake');
            // ping
            socket.write(createPingPacket(BigInt(Date.now())));
            const pingData = await packetDecoder.oncePromise('pong');
            if (timeout) {
                clearTimeout(timeout);
            }
            socket.end();
            resolve({
                ...handshakeData,
                ping: pingData,
            });
        });
        // Destroy on error
        socket.once('error', (error) => {
            socket.destroy();
            if (timeout) {
                clearTimeout(timeout);
            }
            reject(error);
        });
        // Destroy on timeout
        socket.once('timeout', () => {
            socket.destroy();
            if (timeout) {
                clearTimeout(timeout);
            }
            reject(new Error('Timed out'));
        });
        // Packet timeout
        const timeoutValue = (options === null || options === void 0 ? void 0 : options.timeout) || 10000;
        timeout = setTimeout(() => {
            socket.end();
            reject(new Error(`Timed out (${timeoutValue} ms)`));
        }, timeoutValue);
    });
}
function createHandshakePacket(address) {
    const portBuffer = Buffer.allocUnsafe(2);
    portBuffer.writeUInt16BE(address.port, 0);
    // Return hansdhake packet with request packet
    return Buffer.concat([
        createPacket(0, Buffer.concat([
            Buffer.from((0, varint_1.encode)(PROTOCOL_VERSION)),
            Buffer.from((0, varint_1.encode)(address.hostname.length)),
            Buffer.from(address.hostname, 'utf8'),
            portBuffer,
            Buffer.from((0, varint_1.encode)(1)),
        ])),
        createPacket(0, Buffer.alloc(0)),
    ]);
}
function createPingPacket(timestamp) {
    const pingBuffer = Buffer.allocUnsafe(8);
    pingBuffer.writeBigUInt64BE(timestamp);
    return createPacket(1, pingBuffer);
}
function createPacket(packetId, data) {
    return Buffer.concat([Buffer.from((0, varint_1.encode)((0, varint_1.encodingLength)(packetId) + data.length)), Buffer.from((0, varint_1.encode)(packetId)), data]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi9zcmMvIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw2QkFBK0I7QUFDL0IsNkJBQTJDO0FBQzNDLG1DQUE4QztBQUU5QyxtREFBOEM7QUFFOUMsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLENBQUMsQ0FBQyxtQkFBbUI7QUFPakQ7Ozs7R0FJRztBQUNILFNBQWdCLE9BQU8sQ0FBQyxHQUFXLEVBQUUsVUFBbUIsRUFBRTtJQUN6RCxNQUFNLEVBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNoRCxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsUUFBUSxJQUFJLFFBQVEsS0FBSyxZQUFZLEVBQUU7UUFDeEQsTUFBTSxJQUFJLFNBQVMsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0tBQ2pEO0lBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ3ZFLENBQUM7QUFORCwwQkFNQztBQUVEOzs7OztHQUtHO0FBQ0ksS0FBSyxVQUFVLElBQUksQ0FBQyxRQUFRLEdBQUcsV0FBVyxFQUFFLElBQUksR0FBRyxLQUFLLEVBQUUsVUFBbUIsRUFBRTtJQUNyRixJQUFJLE9BQU8sR0FBYSxFQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUMsQ0FBQztJQUN6QyxJQUFJO1FBQ0gsT0FBTyxHQUFHLE1BQU0sY0FBYyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUNqRDtJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ2IsU0FBUztLQUNUO0lBQ0QsT0FBTyxjQUFjLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ3pDLENBQUM7QUFSRCxvQkFR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QUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDO1lBQ3JDLFVBQVU7WUFDVixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUEsZUFBTSxFQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3RCLENBQUMsQ0FDRjtRQUNELFlBQVksQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNoQyxDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxTQUFpQjtJQUMxQyxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN2QyxPQUFPLFlBQVksQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLFFBQWdCLEVBQUUsSUFBWTtJQUNuRCxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUEsZUFBTSxFQUFDLElBQUEsdUJBQWMsRUFBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUEsZUFBTSxFQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUMxSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtyZXNvbHZlU3J2fSBmcm9tICdkbnMnO1xuaW1wb3J0IHtjcmVhdGVDb25uZWN0aW9uLCBpc0lQfSBmcm9tICduZXQnO1xuaW1wb3J0IHtlbmNvZGUsIGVuY29kaW5nTGVuZ3RofSBmcm9tICd2YXJpbnQnO1xuaW1wb3J0IHtJQWRkcmVzcywgSUhhbmRzaGFrZURhdGEsIElNaW5lY3JhZnREYXRhfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHtQYWNrZXREZWNvZGVyfSBmcm9tICcuL1BhY2tldERlY29kZXInO1xuXG5jb25zdCBQUk9UT0NPTF9WRVJTSU9OID0gNzM2OyAvLyBNaW5lY3JhZnQgMS4xNi4xXG5cbmludGVyZmFjZSBPcHRpb25zIHtcblx0LyoqIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzICovXG5cdHRpbWVvdXQ/OiBudW1iZXI7XG59XG5cbi8qKlxuICogcGluZyB3aXRoIFVSSVxuICogQHBhcmFtIHtzdHJpbmd9IHVyaSBtaW5lY3JhZnQ6Ly9zZXJ2ZXJbOnBvcnRdXG4gKiBAcmV0dXJuIHtQcm9taXNlPElNaW5lY3JhZnREYXRhPn1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBpbmdVcmkodXJpOiBzdHJpbmcsIG9wdGlvbnM6IE9wdGlvbnMgPSB7fSk6IFByb21pc2U8SU1pbmVjcmFmdERhdGE+IHtcblx0Y29uc3Qge3Byb3RvY29sLCBob3N0bmFtZSwgcG9ydH0gPSBuZXcgVVJMKHVyaSk7XG5cdGlmICghaG9zdG5hbWUgfHwgIXByb3RvY29sIHx8IHByb3RvY29sICE9PSAnbWluZWNyYWZ0OicpIHtcblx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKCdub3QgY29ycmVjdCBtaW5lY3JhZnQgVVJJJyk7XG5cdH1cblx0cmV0dXJuIHBpbmcoaG9zdG5hbWUsIHBvcnQgPyBwYXJzZUludChwb3J0LCAxMCkgOiB1bmRlZmluZWQsIG9wdGlvbnMpO1xufVxuXG4vKipcbiAqIHBpbmcgd2l0aCBob3N0bmFtZSBhbmQgcG9ydFxuICogQHBhcmFtIHtzdHJpbmc9fSBob3N0bmFtZSBob3N0bmFtZVxuICogQHBhcmFtIHtudW1iZXI9fSBwb3J0IHBvcnQgbnVtYmVyIChkZWZhdWx0cyAyNTU2NSlcbiAqIEByZXR1cm5zIHtQcm9taXNlPElNaW5lY3JhZnREYXRhPn1cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHBpbmcoaG9zdG5hbWUgPSAnbG9jYWxob3N0JywgcG9ydCA9IDI1NTY1LCBvcHRpb25zOiBPcHRpb25zID0ge30pOiBQcm9taXNlPElNaW5lY3JhZnREYXRhPiB7XG5cdGxldCBhZGRyZXNzOiBJQWRkcmVzcyA9IHtob3N0bmFtZSwgcG9ydH07XG5cdHRyeSB7XG5cdFx0YWRkcmVzcyA9IGF3YWl0IGNoZWNrU3J2UmVjb3JkKGFkZHJlc3MuaG9zdG5hbWUpO1xuXHR9IGNhdGNoIChlcnIpIHtcblx0XHQvLyBpZ25vcmVcblx0fVxuXHRyZXR1cm4gb3BlbkNvbm5lY3Rpb24oYWRkcmVzcywgb3B0aW9ucyk7XG59XG5cbmZ1bmN0aW9uIGNoZWNrU3J2UmVjb3JkKGhvc3RuYW1lOiBzdHJpbmcpOiBQcm9taXNlPElBZGRyZXNzPiB7XG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0aWYgKGlzSVAoaG9zdG5hbWUpICE9PSAwKSB7XG5cdFx0XHRyZWplY3QobmV3IEVycm9yKCdIb3N0bmFtZSBpcyBhbiBJUCBhZGRyZXNzJykpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXNvbHZlU3J2KCdfbWluZWNyYWZ0Ll90Y3AuJyArIGhvc3RuYW1lLCAoZXJyb3IsIHJlc3VsdCkgPT4ge1xuXHRcdFx0XHRpZiAoZXJyb3IpIHtcblx0XHRcdFx0XHRyZWplY3QoZXJyb3IpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGlmIChyZXN1bHQubGVuZ3RoID09PSAwIHx8ICFyZXN1bHRbMF0pIHtcblx0XHRcdFx0XHRcdHJlamVjdChuZXcgRXJyb3IoJ2Ruczogbm8gc3J2IGZvdW5kIHdpdGggbmFtZScpKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0cmVzb2x2ZSh7XG5cdFx0XHRcdFx0XHRcdGhvc3RuYW1lOiByZXN1bHRbMF0ubmFtZSxcblx0XHRcdFx0XHRcdFx0cG9ydDogcmVzdWx0WzBdLnBvcnQsXG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdH1cblx0fSk7XG59XG5cbmZ1bmN0aW9uIG9wZW5Db25uZWN0aW9uKGFkZHJlc3M6IElBZGRyZXNzLCBvcHRpb25zOiBPcHRpb25zKTogUHJvbWlzZTxJTWluZWNyYWZ0RGF0YT4ge1xuXHRsZXQgdGltZW91dDogUmV0dXJuVHlwZTx0eXBlb2Ygc2V0VGltZW91dD4gfCB1bmRlZmluZWQ7XG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0Y29uc3Qgc29ja2V0ID0gY3JlYXRlQ29ubmVjdGlvbihhZGRyZXNzLnBvcnQsIGFkZHJlc3MuaG9zdG5hbWUsIGFzeW5jICgpID0+IHtcblx0XHRcdGNvbnN0IHBhY2tldERlY29kZXIgPSBuZXcgUGFja2V0RGVjb2RlcigpO1xuXHRcdFx0c29ja2V0LnBpcGUocGFja2V0RGVjb2Rlcik7XG5cdFx0XHRwYWNrZXREZWNvZGVyLm9uY2UoJ2Vycm9yJywgKGVycm9yKSA9PiB7XG5cdFx0XHRcdHNvY2tldC5kZXN0cm95KCk7XG5cdFx0XHRcdGlmICh0aW1lb3V0KSB7XG5cdFx0XHRcdFx0Y2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHJlamVjdChlcnJvcik7XG5cdFx0XHR9KTtcblx0XHRcdC8vIGhhbmRzaGFrZVxuXHRcdFx0c29ja2V0LndyaXRlKGNyZWF0ZUhhbmRzaGFrZVBhY2tldChhZGRyZXNzKSk7XG5cdFx0XHRjb25zdCBoYW5kc2hha2VEYXRhID0gYXdhaXQgcGFja2V0RGVjb2Rlci5vbmNlUHJvbWlzZTxJSGFuZHNoYWtlRGF0YT4oJ2hhbmRzaGFrZScpO1xuXHRcdFx0Ly8gcGluZ1xuXHRcdFx0c29ja2V0LndyaXRlKGNyZWF0ZVBpbmdQYWNrZXQoQmlnSW50KERhdGUubm93KCkpKSk7XG5cdFx0XHRjb25zdCBwaW5nRGF0YSA9IGF3YWl0IHBhY2tldERlY29kZXIub25jZVByb21pc2U8bnVtYmVyPigncG9uZycpO1xuXHRcdFx0aWYgKHRpbWVvdXQpIHtcblx0XHRcdFx0Y2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuXHRcdFx0fVxuXHRcdFx0c29ja2V0LmVuZCgpO1xuXG5cdFx0XHRyZXNvbHZlKHtcblx0XHRcdFx0Li4uaGFuZHNoYWtlRGF0YSxcblx0XHRcdFx0cGluZzogcGluZ0RhdGEsXG5cdFx0XHR9KTtcblx0XHR9KTtcblx0XHQvLyBEZXN0cm95IG9uIGVycm9yXG5cdFx0c29ja2V0Lm9uY2UoJ2Vycm9yJywgKGVycm9yKSA9PiB7XG5cdFx0XHRzb2NrZXQuZGVzdHJveSgpO1xuXHRcdFx0aWYgKHRpbWVvdXQpIHtcblx0XHRcdFx0Y2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuXHRcdFx0fVxuXHRcdFx0cmVqZWN0KGVycm9yKTtcblx0XHR9KTtcblxuXHRcdC8vIERlc3Ryb3kgb24gdGltZW91dFxuXHRcdHNvY2tldC5vbmNlKCd0aW1lb3V0JywgKCkgPT4ge1xuXHRcdFx0c29ja2V0LmRlc3Ryb3koKTtcblx0XHRcdGlmICh0aW1lb3V0KSB7XG5cdFx0XHRcdGNsZWFyVGltZW91dCh0aW1lb3V0KTtcblx0XHRcdH1cblx0XHRcdHJlamVjdChuZXcgRXJyb3IoJ1RpbWVkIG91dCcpKTtcblx0XHR9KTtcblx0XHQvLyBQYWNrZXQgdGltZW91dFxuXHRcdGNvbnN0IHRpbWVvdXRWYWx1ZSA9IG9wdGlvbnM/LnRpbWVvdXQgfHwgMTAwMDA7XG5cdFx0dGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0c29ja2V0LmVuZCgpO1xuXHRcdFx0cmVqZWN0KG5ldyBFcnJvcihgVGltZWQgb3V0ICgke3RpbWVvdXRWYWx1ZX0gbXMpYCkpO1xuXHRcdH0sIHRpbWVvdXRWYWx1ZSk7XG5cdH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVIYW5kc2hha2VQYWNrZXQoYWRkcmVzczogSUFkZHJlc3MpOiBCdWZmZXIge1xuXHRjb25zdCBwb3J0QnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKDIpO1xuXHRwb3J0QnVmZmVyLndyaXRlVUludDE2QkUoYWRkcmVzcy5wb3J0LCAwKTtcblx0Ly8gUmV0dXJuIGhhbnNkaGFrZSBwYWNrZXQgd2l0aCByZXF1ZXN0IHBhY2tldFxuXHRyZXR1cm4gQnVmZmVyLmNvbmNhdChbXG5cdFx0Y3JlYXRlUGFja2V0KFxuXHRcdFx0MCxcblx0XHRcdEJ1ZmZlci5jb25jYXQoW1xuXHRcdFx0XHRCdWZmZXIuZnJvbShlbmNvZGUoUFJPVE9DT0xfVkVSU0lPTikpLFxuXHRcdFx0XHRCdWZmZXIuZnJvbShlbmNvZGUoYWRkcmVzcy5ob3N0bmFtZS5sZW5ndGgpKSxcblx0XHRcdFx0QnVmZmVyLmZyb20oYWRkcmVzcy5ob3N0bmFtZSwgJ3V0ZjgnKSxcblx0XHRcdFx0cG9ydEJ1ZmZlcixcblx0XHRcdFx0QnVmZmVyLmZyb20oZW5jb2RlKDEpKSxcblx0XHRcdF0pLFxuXHRcdCksXG5cdFx0Y3JlYXRlUGFja2V0KDAsIEJ1ZmZlci5hbGxvYygwKSksXG5cdF0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVQaW5nUGFja2V0KHRpbWVzdGFtcDogYmlnaW50KSB7XG5cdGNvbnN0IHBpbmdCdWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoOCk7XG5cdHBpbmdCdWZmZXIud3JpdGVCaWdVSW50NjRCRSh0aW1lc3RhbXApO1xuXHRyZXR1cm4gY3JlYXRlUGFja2V0KDEsIHBpbmdCdWZmZXIpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVQYWNrZXQocGFja2V0SWQ6IG51bWJlciwgZGF0YTogQnVmZmVyKTogQnVmZmVyIHtcblx0cmV0dXJuIEJ1ZmZlci5jb25jYXQoW0J1ZmZlci5mcm9tKGVuY29kZShlbmNvZGluZ0xlbmd0aChwYWNrZXRJZCkgKyBkYXRhLmxlbmd0aCkpLCBCdWZmZXIuZnJvbShlbmNvZGUocGFja2V0SWQpKSwgZGF0YV0pO1xufVxuIl19